# 二次验证功能使用说明

## 功能概述

Watch Docker 支持二次验证（Two-Factor Authentication，2FA）功能，提供额外的安全保护。支持两种验证方式：

1. **OTP（一次性密码）**：基于 TOTP 协议，使用 Google Authenticator、Authy、微软身份验证器等应用
2. **WebAuthn（生物验证）**：支持指纹、Face ID、Windows Hello 等生物识别方式

## 启用二次验证

### 1. 系统管理员启用功能

在启动 Watch Docker 时，设置环境变量：

```bash
IS_SECONDARY_VERIFICATION=true
```

或在 Docker Compose 配置中：

```yaml
environment:
  - IS_SECONDARY_VERIFICATION=true
```

### 2. 用户首次设置

当二次验证功能启用后，用户首次登录时需要设置验证方式：

#### OTP 设置步骤

1. 登录时输入用户名和密码
2. 选择"OTP (一次性密码)"
3. 点击"生成二维码"
4. 使用身份验证器应用扫描二维码
5. 输入验证器应用显示的 6 位验证码
6. 完成设置

#### WebAuthn 设置步骤

1. 登录时输入用户名和密码
2. 选择"WebAuthn (生物验证)"
3. 点击"开始设置"
4. 按照浏览器提示完成生物识别注册
5. 完成设置

## 日常使用

设置完成后，每次登录都需要进行二次验证：

### OTP 验证

1. 输入用户名和密码
2. 打开身份验证器应用
3. 输入当前显示的 6 位验证码
4. 完成登录

### WebAuthn 验证

1. 输入用户名和密码
2. 点击"使用生物验证"按钮
3. 按照浏览器提示完成生物识别
4. 完成登录

## 管理二次验证

### 查看状态

进入"系统设置"页面，在"二次验证"部分可以查看：

- 当前状态（已启用/未启用）
- 验证方式（OTP/WebAuthn）

### 禁用二次验证

在"系统设置"页面点击"禁用二次验证"按钮即可关闭。

**注意**：禁用后需要重新设置才能再次启用。

## 安全建议

1. **妥善保管密钥**：OTP 密钥一旦丢失，将无法登录。建议在设置时备份密钥或截图保存二维码
2. **多设备备份**：可以在多个设备上添加同一个 OTP 密钥
3. **定期检查**：定期确认二次验证功能正常工作
4. **浏览器兼容性**：WebAuthn 需要浏览器支持，推荐使用最新版本的 Chrome、Firefox、Safari 或 Edge

## 故障排除

### 无法扫描二维码

- 尝试使用"手动输入密钥"功能
- 复制密钥到身份验证器应用中手动添加

### 验证码错误

- 确保设备时间准确（OTP 基于时间生成）
- 等待下一个验证码再试
- 检查是否输入了正确的 6 位数字

### WebAuthn 不可用

- 确认浏览器支持 WebAuthn
- 检查是否启用了生物识别功能
- 尝试使用 HTTPS 连接（某些浏览器要求）

## 技术细节

### OTP（TOTP）

- 基于时间的一次性密码算法（RFC 6238）
- 30 秒刷新一次
- 6 位数字验证码
- 密钥使用 Base32 编码存储

### WebAuthn

- 基于 FIDO2 标准
- 公钥加密，私钥保存在设备中
- 支持多种认证器（平台认证器、安全密钥等）
- 更高的安全性，防止钓鱼攻击

## 配置存储

二次验证配置存储在主配置文件中：

```
<CONFIG_PATH>/config.yaml
```

在配置文件的 `twofa` 部分：

```yaml
twofa:
  users:
    admin:
      method: "otp"
      otpSecret: "BASE32_ENCODED_SECRET"
      isSetup: true
```

**说明**：

- 二次验证的启用与否由 `IS_SECONDARY_VERIFICATION` 环境变量统一控制
- 用户配置只包含验证方法、凭据和设置状态

**警告**：不要手动编辑二次验证配置，以免导致配置损坏。所有配置应通过 Web 界面管理。
